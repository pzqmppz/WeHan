# WeHan 平台总体架构

> 武汉人才留汉智能服务平台 - B 端 + C 端完整技术架构

**更新时间**: 2026-02-28 | **版本**: 3.0

---

## 一、系统架构图（单 Agent 版）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        WeHan 平台总体架构                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────┐  ┌─────────────────────────────┐  │
│  │          C 端 (学生端)           │  │       B 端 (管理端)          │  │
│  │         WeHan 求职助手           │  │        才聚江城              │  │
│  ├─────────────────────────────────┤  ├─────────────────────────────┤  │
│  │                                 │  │                             │  │
│  │  ┌───────────┐                  │  │  ┌───────────────────────┐  │  │
│  │  │ 豆包 App  │                  │  │  │   企业门户            │  │  │
│  │  │ (用户入口) │                  │  │  │   - 岗位管理          │  │  │
│  │  └─────┬─────┘                  │  │  │   - 简历筛选          │  │  │
│  │        │                        │  │  │   - 面试安排          │  │  │
│  │  ┌─────▼─────────────────────┐  │  │  └───────────────────────┘  │  │
│  │  │    WeHan 求职助手 (单Bot)  │  │  │                             │  │
│  │  │    ┌──────────────────┐    │  │  ┌───────────────────────┐  │  │
│  │  │    │【主Bot】极简路由  │    │  │  │   政府门户            │  │  │
│  │  │    │意图识别:面试vs心理│    │  │  │   - 政策管理          │  │  │
│  │  │    └────────┬─────────┘    │  │  │   - 数据统计          │  │  │
│  │  │             │              │  │  └───────────────────────┘  │  │
│  │  │    ┌────────┴────────┐     │  │                             │  │
│  │  │    ▼                 ▼     │  │  ┌───────────────────────┐  │  │
│  │  │ ┌────────┐      ┌────────┐ │  │  │   学校门户            │  │  │
│  │  │ │技能1:  │      │技能2:  │ │  │  │   - 学生管理          │  │  │
│  │  │ │AI面试  │      │心理疏导│ │  │  │   - 岗位推送          │  │  │
│  │  │ │(工作流) │      │(子技能)│ │  │  └───────────────────────┘  │  │
│  │  │ └────────┘      └────────┘ │  │  │                             │  │
│  │  │                         │  │  │  ┌───────────────────────┐  │  │
│  │  │ 技术栈: 扣子 + 火山引擎   │  │  │  │   管理员后台          │  │  │
│  │  │       + 云端数据库       │  │  │  │   - 用户管理          │  │  │
│  │  └─────────────────────────┘  │  │  │   - 系统配置          │  │  │
│  └──────────────┬──────────────────┘  │  └───────────────────────┘  │  │
│                 │                     │                             │  │
│                 │                     │  技术栈: Next.js + Ant Design│  │
│                 │                     │                             │  │
│                 │                     └──────────────┬──────────────┘  │
│                 │                                    │                 │
│                 │         ┌──────────────────────────┘                 │
│                 │         │                                            │
│                 ▼         ▼                                            │
│  ┌────────────────────────────────────────────────────────────────┐   │
│  │                       数据互通层                                 │   │
│  ├────────────────────────────────────────────────────────────────┤   │
│  │                                                                 │   │
│  │   ┌─────────────────┐              ┌─────────────────────┐     │   │
│  │   │   开放 API       │◄────────────│   HTTP 插件         │     │   │
│  │   │   /api/open/*   │   REST API   │   (扣子平台)        │     │   │
│  │   └────────┬────────┘              └─────────────────────┘     │   │
│  │            │                                                    │   │
│  │            ▼                                                    │   │
│  │   ┌────────────────────────────────────────────────────────┐   │   │
│  │   │                    PostgreSQL                           │   │   │
│  │   │   • users        • jobs         • applications         │   │   │
│  │   │   • enterprises  • resumes      • interviews           │   │   │
│  │   │   • schools      • policies     • conversations        │   │   │
│  │   │   • statistics   • emotion_records                     │   │   │
│  │   └────────────────────────────────────────────────────────┘   │   │
│  │                                                                 │   │
│  └────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 二、双端定位（单 Agent 版）

| 维度 | C 端 (WeHan) | B 端 (才聚江城) |
|-----|-------------|----------------|
| **目标用户** | 毕业生/求职者 | 企业/政府/学校/管理员 |
| **品牌名称** | WeHan 求职助手 | 才聚江城 |
| **访问方式** | 豆包 App / 分享链接 | Web 浏览器 |
| **核心价值** | AI 面试、岗位匹配、心理疏导（统一入口） | 岗位发布、简历管理、数据分析 |
| **技术平台** | 扣子智能体 + 豆包（单 Bot + 技能路由） | Next.js + Ant Design |
| **开发模式** | 本地配置 + API 上传 | 代码开发为主 |
| **架构特点** | 纯 B 端 API 架构、上下文隔离、云端数据库持久化 | 分层架构、多租户隔离 |

---

## 三、B 端分层架构

### 3.1 请求流向

```
┌─────────────────────────────────────────────────────────────────┐
│                        B 端请求流向                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐                                                │
│  │   Client    │  用户请求                                      │
│  │   (React)   │                                                │
│  └──────┬──────┘                                                │
│         │                                                       │
│         ▼                                                       │
│  ┌─────────────┐     ┌─────────────┐                           │
│  │  API Route  │────►│   Zod       │  输入验证                  │
│  │  /api/*     │     │   Validator │                           │
│  └──────┬──────┘     └─────────────┘                           │
│         │                                                       │
│         ▼                                                       │
│  ┌─────────────┐                                                │
│  │   Service   │  业务逻辑层                                     │
│  │   Layer     │  - 数据处理                                    │
│  │             │  - 业务规则                                    │
│  └──────┬──────┘                                                │
│         │                                                       │
│         ▼                                                       │
│  ┌─────────────┐                                                │
│  │ Repository  │  数据访问层                                     │
│  │   Layer     │  - SQL 查询                                    │
│  │             │  - 数据映射                                    │
│  └──────┬──────┘                                                │
│         │                                                       │
│         ▼                                                       │
│  ┌─────────────┐                                                │
│  │  PostgreSQL │  数据存储                                       │
│  └─────────────┘                                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 层级职责

| 层级 | 目录 | 职责 |
|-----|------|------|
| API Route | `app/api/*` | 接收请求、调用 Service、返回响应 |
| Validator | `lib/validators/` | Zod 运行时类型验证 |
| Service | `services/` | 业务逻辑处理、数据校验 |
| Repository | `repositories/` | 数据库操作、SQL 查询 |
| Database | PostgreSQL | 数据持久化存储 |

### 3.3 目录结构

```
web/src/
├── app/api/                   # API 路由层
├── services/                  # 业务逻辑层
│   ├── index.ts              # 统一导出
│   ├── job.service.ts        # 岗位业务
│   └── application.service.ts # 投递业务
├── repositories/              # 数据访问层
│   ├── index.ts              # 统一导出
│   ├── base.repository.ts    # 基类
│   ├── job.repository.ts     # 岗位数据
│   └── application.repository.ts # 投递数据
├── lib/validators/            # 验证层
│   └── index.ts              # Zod Schemas
└── lib/mocks/                 # Mock 数据
    └── dashboard.mock.ts
```

---

## 四、数据流向

### 4.1 岗位数据流

```
┌─────────────┐     发布岗位      ┌─────────────┐
│   企业 B 端  │ ────────────────► │  PostgreSQL │
└─────────────┘                   │   jobs 表   │
                                  └──────┬──────┘
                                         │
                          ┌──────────────┼──────────────┐
                          │              │              │
                          ▼              ▼              ▼
                   ┌──────────┐   ┌──────────┐   ┌──────────┐
                   │ 开放 API │   │ 统计聚合 │   │ B端查询  │
                   │ /api/... │   │          │   │          │
                   └────┬─────┘   └──────────┘   └──────────┘
                        │
                        ▼
                   ┌──────────────────────┐
                   │    C 端岗位搜索       │
                   │    (B端 API 直接调用)  │
                   └──────────────────────┘
```

### 4.2 投递数据流

```
┌─────────────┐                   ┌─────────────┐
│   C 端投递  │                   │   B 端接收  │
│  (扣子插件) │                   │  (企业门户) │
└──────┬──────┘                   └──────▲──────┘
       │                                 │
       │  POST /api/open/applications    │
       │                                 │
       ▼                                 │
┌─────────────────────────────────────────┐
│              PostgreSQL                  │
│           applications 表                │
│                                         │
│  状态流转: PENDING → VIEWED →           │
│           INTERVIEWING → OFFERED        │
└─────────────────────────────────────────┘
```

### 4.3 面试数据流

```
┌─────────────┐                   ┌─────────────┐
│   C 端面试  │                   │   B 端查看  │
│  (语音对话) │                   │  (评估报告) │
└──────┬──────┘                   └──────▲──────┘
       │                                 │
       │  1. 创建面试记录                │
       │  2. 语音对话过程                │
       │  3. AI 生成评估报告             │
       │  4. 保存报告                    │
       │                                 │
       ▼                                 │
┌─────────────────────────────────────────┐
│              PostgreSQL                  │
│           interviews 表                  │
│                                         │
│  • outline (面试题目)                    │
│  • conversation (对话记录)               │
│  • totalScore (综合评分)                 │
│  • dimensions (维度评分)                 │
│  • audioUrl (录音文件)                   │
└─────────────────────────────────────────┘
```

---

## 五、开发阶段规划（单 Agent 版）

### 第一阶段：基础设施（1 周）

| 任务 | 负责端 | 交付物 |
|-----|-------|-------|
| 数据库 Schema 完善 | B 端 | Prisma schema（含 conversations 表） |
| NextAuth.js 认证 | B 端 | 4 角色登录 |
| 路由守卫中间件 | B 端 | 权限拦截 |
| WeHan 求职助手创建 | C 端 | 单 Bot + 路由 Prompt |
| 开场白 + 意图识别 | C 端 | 技能路由正常工作 |

### 第二阶段：核心功能（2 周）

| 任务 | 负责端 | 交付物 |
|-----|-------|-------|
| 岗位管理 CRUD | B 端 | 企业岗位页面 |
| 开放 API /api/open/* | B 端 | C 端可调用 |
| 实时语音集成 | C 端 | 语音对话功能 |
| 面试模拟工作流 | C 端 | 完整面试流程（上下文隔离） |
| 报告保存到 B 端 | C+B | HTTP 插件联调 |

### 第三阶段：业务闭环（2 周）

| 任务 | 负责端 | 交付物 |
|-----|-------|-------|
| 简历管理 | B 端 | 企业筛选页面 |
| 投递管理 | B 端 | 状态流转 |
| 简历解析 | C 端 | AI 解析 + 云端存储 |
| 岗位匹配 | C 端 | B 端 API + 大模型 |
| 会话恢复功能 | C 端 | 历史会话列表 + 断点续接 |

### 第四阶段：扩展功能（2 周）

| 任务 | 负责端 | 交付物 |
|-----|-------|-------|
| 政策管理 | B 端 | 政府门户 |
| 数据统计 | B 端 | 统计大屏 |
| 学生管理 | B 端 | 学校门户 |
| 情绪记录追踪 | C 端 | emotion_records 表 |
| 管理员后台 | B 端 | 系统管理 |

---

## 六、联调测试计划

### 6.1 联调环境

| 环境 | B 端 | C 端 |
|-----|------|------|
| 开发 | localhost:3000 | 扣子预览模式 |
| 测试 | test.wehan.com | 豆包测试版 |
| 生产 | www.wehan.com | 豆包正式版 |

### 6.2 联调检查点

| 检查点 | 测试内容 | 验收标准 |
|-------|---------|---------|
| API 连通性 | C 端调用 B 端 API | 返回正确数据 |
| 认证鉴权 | API Key 验证 | 未授权请求拒绝 |
| 数据一致性 | C 端投递 → B 端可见 | 数据同步 |
| 语音质量 | 实时对话延迟 | < 500ms |
| 报告完整性 | 面试报告存储 | 所有字段保存 |

### 6.3 端到端测试用例

```
用例 1：完整求职流程
1. C 端：用户上传简历 → AI 解析成功
2. C 端：用户搜索岗位 → 返回匹配岗位
3. C 端：用户发起 AI 面试 → 生成评估报告
4. C 端：用户一键投递 → 提交成功
5. B 端：企业收到投递 → 查看简历和报告
6. B 端：企业安排面试 → 状态更新
7. C 端：用户查看投递状态 → 显示最新状态

用例 2：政策发布流程
1. B 端：政府发布政策 → 保存成功
2. C 端：用户查询政策 → 返回新政策
3. C 端：用户询问政策详情 → AI 解答
```

---

## 七、部署架构

```
┌─────────────────────────────────────────────────────────────┐
│                      生产环境部署                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    CDN / 域名                        │   │
│  │         www.wehan.com (B 端)                        │   │
│  │         豆包 App (C 端入口)                          │   │
│  └─────────────────────────┬───────────────────────────┘   │
│                            │                               │
│  ┌─────────────────────────▼───────────────────────────┐   │
│  │                  Vercel / 云服务器                    │   │
│  │                                                      │   │
│  │   ┌─────────────┐    ┌─────────────┐                │   │
│  │   │  Next.js    │    │  API Routes │                │   │
│  │   │  (SSR/SSG)  │    │  /api/*     │                │   │
│  │   └─────────────┘    └─────────────┘                │   │
│  │                                                      │   │
│  └─────────────────────────┬───────────────────────────┘   │
│                            │                               │
│  ┌─────────────────────────▼───────────────────────────┐   │
│  │                  PostgreSQL                          │   │
│  │              (云数据库 / Supabase)                    │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              扣子平台 (SaaS)                         │   │
│  │   • 智能体运行环境                                   │   │
│  │   • 语音服务 (火山引擎)                              │   │
│  │   • 工作流运行环境（网页手动配置）                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 八、数据库环境配置

### 8.1 环境变量管理

| 文件 | 用途 | Git 状态 |
|-----|------|---------|
| `.env` | 实际配置（本地/云端） | ❌ 不提交 |
| `.env.example` | 配置模板 | ✅ 提交 |
| `.env.local` | 本地覆盖配置 | ❌ 不提交 |

### 8.2 数据库连接配置

| 环境 | 变量 | 说明 |
|-----|------|------|
| 云端开发 | `DATABASE_URL` | Supabase 连接字符串 |
| 本地开发 | `DATABASE_URL` | 本地 PostgreSQL |

### 8.3 配置切换

```bash
# 使用云端数据库（Supabase）
DATABASE_URL="postgresql://postgres.xxx:密码@xxx.pooler.supabase.com:5432/postgres"

# 使用本地数据库
# DATABASE_URL="postgresql://postgres:postgres@localhost:5432/wehan?schema=public"
```

### 8.4 云服务商

| 服务商 | 免费额度 | 当前使用 |
|-------|---------|---------|
| Supabase | 500MB | ✅ 已配置 |
| Neon | 3GB | 备选 |
| 本地 PostgreSQL | 无限制 | 本地部署用 |

### 8.5 关键环境变量

| 变量 | 说明 | 必填 |
|-----|------|-----|
| `DATABASE_URL` | 数据库连接字符串 | ✅ |
| `NEXTAUTH_SECRET` | NextAuth 加密密钥 | ✅ |
| `NEXTAUTH_URL` | 应用 URL | ✅ |
| `OPEN_API_KEY` | C 端 API 调用密钥 | 🟡 |
| `VOLCENGINE_*` | 火山引擎语音 API | 🟡 C 端用 |

---

## 九、监控与运维

### 9.1 监控指标

| 层级 | 指标 | 阈值 |
|-----|------|-----|
| B 端 API | 响应时间 | < 200ms |
| B 端 API | 错误率 | < 1% |
| C 端语音 | 连接成功率 | > 98% |
| C 端语音 | 端到端延迟 | < 500ms |
| 数据库 | 查询时间 | < 50ms |
| 数据库 | 连接池使用率 | < 80% |

### 9.2 日志规范

```typescript
// B 端日志
{
  "timestamp": "2026-02-27T10:00:00Z",
  "level": "info",
  "service": "wehan-api",
  "action": "application.create",
  "userId": "user_xxx",
  "metadata": {
    "jobId": "job_xxx",
    "source": "coze-plugin"
  }
}

// C 端日志（扣子平台）
{
  "event": "interview.completed",
  "user_id": "user_xxx",
  "duration": 1800,
  "score": 78,
  "job_id": "job_xxx"
}
```

---

## 十、安全策略

### 10.1 认证与授权

| 层级 | 方式 | 说明 |
|-----|------|-----|
| B 端用户 | NextAuth.js Session | Cookie-based |
| B 端 API | Session + CSRF | 双重验证 |
| 开放 API | API Key | 扣子插件专用 |
| C 端用户 | 豆包账号体系 | 由豆包管理 |

### 10.2 数据安全

| 措施 | 说明 |
|-----|------|
| HTTPS | 全站加密传输 |
| 密码加密 | bcrypt + salt |
| 敏感数据脱敏 | 日志中隐藏手机号、邮箱 |
| SQL 注入防护 | Prisma 参数化查询 |
| XSS 防护 | React 自动转义 + CSP |

---

## 十一、文档索引

| 文档 | 路径 | 说明 |
|-----|------|------|
| B 端技术框架 | [codemaps/backend-portal.md](./backend-portal.md) | 分层架构 + 设计系统 |
| C 端技术框架 | [codemaps/frontend-client.md](./frontend-client.md) | 扣子 + 豆包 |
| 数据模型 | [codemaps/data-models.md](./data-models.md) | Prisma Schema |
| 设计系统 | [docs/design-system.md](../docs/design-system.md) | UI/UX 规范 |
| 扣子文档 | [docs/coze/README.md](../docs/coze/README.md) | 平台使用指南 |
| 火山引擎文档 | [docs/volcengine/README.md](../docs/volcengine/README.md) | 语音 API |
| PRD | [PRD-武汉人才留汉智能服务平台.md](../PRD-武汉人才留汉智能服务平台.md) | 产品需求 |

---

*文档版本: 3.0 | 更新时间: 2026-02-28*
*变更: 纯 B 端 API 架构（移除知识库依赖）、API 测试验证结果、架构变更记录*
