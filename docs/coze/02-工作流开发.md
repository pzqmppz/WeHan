# 扣子工作流开发

## 概述

工作流（Workflow）是扣子平台的核心能力，可以将多个步骤串成多节点流程，支持循环、判断等复杂逻辑。

## 工作流结构

```yaml
schema_version: 1.0.0
name: 工作流名称
id: 7482702358159*****
description: 工作流描述
mode: workflow
icon: plugin_icon/workflow.png
nodes:
  - id: "100001"
    type: start
    title: 开始
    ...
  - id: "900001"
    type: end
    title: 结束
    ...
```

## 节点类型

### 1. 开始节点 (Start)
- 工作流的起始节点
- 设定启动工作流需要的输入参数
- 支持参数类型：string, number, boolean, object, array

### 2. 结束节点 (End)
- 工作流的最终节点
- 返回工作流运行后的结果信息

### 3. 大模型节点 (LLM)
- 调用大语言模型处理文本
- 配置系统提示词和用户提示词

### 4. 插件节点 (Plugin)
- 调用外部 API 或插件
- 如：读取网页内容、图片生成等

### 5. HTTP 请求节点
- 发送 HTTP 请求获取数据
- 支持 GET, POST, PUT, DELETE 等方法
- 支持鉴权配置（Bearer Token、自定义）

### 6. 条件节点 (Condition)
- 实现分支逻辑
- 支持 if-else 判断

### 7. 循环节点 (Loop)
- 实现循环逻辑
- 遍历数组或重复执行

## HTTP 请求节点配置

| 配置项 | 说明 |
|-------|------|
| API | 请求地址和方法 |
| 请求参数 | URL 后面的键值对 |
| 请求头 | User-Agent、Accept 等 |
| 鉴权 | Bearer Token 或自定义 |
| 请求体 | form-data / JSON / raw text |
| 超时设置 | 默认 120s，最长 600s |
| 重试次数 | 默认 3 次，最大 10 次 |
| 异常忽略 | 开启后节点失败不中断流程 |

## 执行工作流 API

### 请求

```http
POST https://api.coze.cn/v1/workflow/run
Authorization: Bearer {Access_Token}
Content-Type: application/json
```

```json
{
  "workflow_id": "73664689170551******",
  "parameters": {
    "user_name": "John Doe",
    "input": "Hello, world!"
  },
  "bot_id": "73428668******",
  "is_async": false
}
```

### 参数说明

| 参数 | 类型 | 必填 | 说明 |
|-----|------|-----|------|
| workflow_id | String | 是 | 工作流 ID |
| parameters | Object | 否 | 输入参数 |
| bot_id | String | 否 | 关联的智能体 ID |
| is_async | Boolean | 否 | 是否异步执行 |
| workflow_version | String | 否 | 工作流版本 |

### 响应

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "debug_url": "https://www.coze.cn/work_flow?execute_id=xxx",
    "execute_id": "exec_1234567890abcdef"
  }
}
```

## 异步执行

对于长时间运行的工作流，建议使用异步执行：

1. 设置 `is_async: true`
2. 获取返回的 `execute_id`
3. 调用查询 API 获取执行结果

## 工作流示例

### 示例：总结文章要点

```
开始 → 读取网页内容 → 大模型总结 → 结束
```

**节点配置：**

1. **开始节点**
   - 输入：article_url (string)

2. **插件节点（读取网页内容）**
   - 使用 LinkReaderPlugin
   - 输入：{{start.article_url}}

3. **大模型节点**
   - 系统提示：你是文章摘要助手
   - 用户提示：总结以下文章的要点：{{plugin.content}}

4. **结束节点**
   - 输出：summary, points

## 最佳实践

1. **模块化设计**：将复杂流程拆分为多个工作流
2. **错误处理**：开启异常忽略，添加错误处理分支
3. **参数验证**：在开始节点设置参数类型和必填
4. **调试优化**：使用 debug_url 查看每个节点的输入输出

## 相关链接

- 工作流文档: https://docs.coze.cn/guides/workflow
- HTTP 节点文档: https://docs.coze.cn/guides/http_node
