# WeHan C 端 Coze 技术框架 v3.1

> **架构更新**：采用「B 端 API 单一数据源」架构，仅包含已验证可用的 API

**更新时间**: 2026-02-28 (v3.1 - 仅保留已验证信息)

---

## 重要说明

本文档**仅包含已通过实际测试验证**的 API 端点和功能。

所有未经验证的内容（包括官方文档中描述但测试返回 404 的端点）已移至沟通文档中保存。

---

## 一、已验证可用的 API 端点

### 1.1 智能体管理 API

| 功能 | 端点 | 方法 | 验证状态 | 测试时间 |
|-----|------|------|---------|---------|
| 创建智能体 | `/v1/bot/create` | POST | ✅ 200 OK | 2026-02-28 |
| 更新智能体 | `/v1/bot/update` | POST | ✅ 200 OK | 2026-02-28 |
| 获取智能体列表 | `/v1/bots` | GET | ✅ 200 OK | 2026-02-28 |

### 1.2 参数说明

| 参数 | 正确命名 | 说明 |
|-----|---------|------|
| 空间 ID | `space_id` | 用于创建/更新智能体 |
| 列表参数 | `workspace_id` | 用于获取智能体列表（全小写） |

### 1.3 请求示例

```python
import requests

PAT = "pat_YOUR_PAT"
SPACE_ID = "YOUR_SPACE_ID"
headers = {
    "Authorization": f"Bearer {PAT}",
    "Content-Type": "application/json"
}

# 创建智能体（已验证）
response = requests.post(
    "https://api.coze.cn/v1/bot/create",
    headers=headers,
    json={
        "space_id": SPACE_ID,
        "name": "测试智能体",
        "prompt": {"system_prompt": "你是一个助手"}
    }
)
# 返回: {"code":0,"msg":"success","data":{"bot_id":"..."}}
```

---

## 二、不可用的 API 端点（已验证）

### 2.1 官方文档描述但测试返回 404

| 功能 | 官方文档端点 | 测试结果 | 测试时间 |
|-----|-------------|---------|---------|
| 创建智能体 | `POST /v1/bot` | ❌ 404 | 2026-02-28 |
| 更新智能体 | `PATCH /v1/bot/{id}` | ❌ 404 | 2026-02-28 |
| 创建工作流 | `POST /v1/workflow` | ❌ 404 | 2026-02-28 |
| 创建知识库 | `POST /v1/knowledge_base` | ❌ 404 | 2026-02-28 |

### 2.2 未找到可用端点的功能

| 功能 | 测试端点数 | 结果 |
|-----|-----------|------|
| 工作流管理 | 12+ 种变体 | 全部 404 |
| 知识库管理 | 8+ 种变体 | 全部 404 |

---

## 三、架构设计（基于已验证 API）

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        WeHan 求职助手（单 Bot）                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  【主 Bot】WeHan 求职助手                                  │  │
│  │  ├── 意图识别：面试 vs 心理疏导 vs 岗位查询 vs 政策咨询    │  │
│  │  ├── 路由规则：                                            │  │
│  │  │   "面试/刷题/简历" → 触发面试工作流（网页手动配置）      │  │
│  │  │   "查岗位/找工作" → HTTP 查询 B 端岗位 API             │  │
│  │  │   "政策/补贴" → HTTP 查询 B 端政策 API                 │  │
│  │  │   "焦虑/压力大" → 触发心理疏导                         │  │
│  │  └── 技能分发                                              │  │
│  └───────────────────────────────────────────────────────────┘  │
│                            │                                   │
│         ┌──────────────────┴──────────────────┐                │
│         ▼                  ▼                  ▼                │
│  ┌─────────────┐   ┌─────────────┐   ┌─────────────┐          │
│  │ 面试工作流   │   │ 岗位查询    │   │ 政策查询    │          │
│  │ (网页配置)   │   │ (HTTP API)  │   │ (HTTP API)  │          │
│  │ → B端API    │   │ → B端API    │   │ → B端API    │          │
│  └─────────────┘   └─────────────┘   └─────────────┘          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     B 端数据库 (PostgreSQL)                  │
│  ├── jobs (岗位)        ├── policies (政策)                  │
│  ├── resumes (简历)    ├── applications (投递)               │
│  └── interviews (面试) └── conversations (会话)              │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 技术限制与解决方案

| 限制 | 影响 | 解决方案 |
|-----|------|---------|
| 工作流 API 不可用 | 无法通过 API 创建工作流 | 在 Coze 网页平台手动配置 |
| 知识库 API 不可用 | 无法通过 API 创建知识库 | 直接使用 B 端 API 查询数据 |
| 绑定 API 不可用 | 无法通过 API 绑定组件 | 在网页平台手动绑定 |

---

## 四、项目结构（简化版）

```
wehan_coze/
├── config/                      # 配置层
│   ├── settings.py              # 环境配置
│   ├── schema/                  # JSON Schema 校验
│   └── local/                   # 本地配置文件
│       ├── wehan_bot.json       # 智能体配置
│       └── interview_workflow.json  # 工作流配置（手动导入）
│
├── coze/                        # Coze 平台封装（仅智能体）
│   └── admin.py                 # 管理API（创建/更新/发布）
│
├── api/                         # B 端 API 对接
│   ├── jobs.py                  # 岗位查询
│   ├── policies.py              # 政策查询
│   ├── interviews.py            # 面试报告
│   └── conversations.py         # 会话管理
│
├── core/                        # 通用能力
│   ├── exceptions.py
│   ├── retry.py
│   └── logger.py
│
└── main/
    └── deploy_simple.py        # 简化部署流程
```

**已移除的组件**（API 不可用）：
- ❌ `coze/knowledge.py` - 知识库管理
- ❌ `coze/workflow.py` - 工作流管理
- ❌ `main/main_upload.py` - 完整上传流程

---

## 五、部署流程

### 5.1 已验证的部署步骤

```bash
# 1. 配置环境变量
cd client
cp .env.example .env
# 编辑 .env 填入 PAT 和 SPACE_ID

# 2. 部署智能体
python main/deploy_simple.py

# 输出示例：
# [OK] 配置校验通过
# [OK] 智能体创建成功
#       智能体 ID: 7611738584064098310
```

### 5.2 后续手动配置（必需）

由于工作流 API 不可用，需要在网页平台手动配置：

1. **登录 Coze 平台**
   - 访问 https://www.coze.cn
   - 找到创建的智能体

2. **配置工具函数**
   - 添加 `get_jobs` 函数：调用 `GET /api/open/jobs`
   - 添加 `get_policies` 函数：调用 `GET /api/open/policies`

3. **手动配置工作流**（如果需要面试功能）
   - 在网页平台创建工作流
   - 添加 HTTP 节点调用 B 端 API
   - 配置语音交互

4. **测试和发布**
   - 在预览面板测试
   - 发布到豆包

---

## 六、API 端点完整测试记录

### 6.1 测试环境

| 配置项 | 值 |
|-------|-----|
| **测试时间** | 2026-02-28 10:15-10:20 |
| **测试方法** | Python requests + curl 穷举 |
| **测试端点数** | 35+ |
| **测试 PAT** | pat_8A26QtZb1Gq06qXOwsS461ssE1q3WtAwnlLd47SEJt5iuSKLk9XQJMZyM8HwYDGQ |
| **测试 SPACE_ID** | 7491691397280874533 |

### 6.2 测试结果汇总

| 类别 | 可用 | 不可用 |
|-----|------|--------|
| **智能体 API** | 3 个 | 5 个 |
| **工作流 API** | 0 个 | 12+ 个 |
| **知识库 API** | 0 个 | 8+ 个 |

### 6.3 可用端点详情

```
✅ POST /v1/bot/create           -> 200 OK
✅ POST /v1/bot/update           -> 200 OK
✅ GET  /v1/bots?workspace_id=   -> 200 OK
```

---

## 七、与官方文档的差异

### 7.1 差异对比

| 功能 | 官方文档所述 | 实际测试结果 | 建议 |
|-----|-------------|-------------|------|
| 创建智能体 | `POST /v1/bot` | 返回 404 | 使用 `/v1/bot/create` |
| 创建工作流 | `POST /v1/workflow` | 返回 404 | 网页平台手动配置 |
| 创建知识库 | `POST /v1/knowledge_base` | 返回 404 | 使用 B 端 API |

### 7.2 建议

1. **本文档**：仅包含已验证可用的信息
2. **官方文档**：参考但需实际验证
3. **沟通文档**：保留所有信息（包括官方未验证的解答）用于问题反馈

---

## 八、开发状态

### 8.1 已完成

- ✅ API 端点完整测试（35+ 端点）
- ✅ 架构设计（v3.0 纯 API 架构）
- ✅ 智能体成功创建（Bot ID: 7611738584064098310）
- ✅ 代码框架搭建
- ✅ 断点恢复功能设计（工作流 v2.0）
- ✅ B端 Interview 表字段更新（currentIndex, answers）

### 8.2 进行中

- ⏳ 在 Coze 网页平台配置工具函数
- ⏳ 在 Coze 网页平台手动配置面试工作流
- ⏳ 测试岗位查询功能
- ⏳ 测试政策查询功能

### 8.3 待完成

- ⏳ 测试完整面试流程（含断点恢复）
- ⏳ 发布到豆包

---

## 九、面试断点恢复流程

### 9.1 工作流节点（v2.0）

```
开始 → 获取简历 → 获取岗位 → 生成题目 → 创建面试记录
    → 语音面试 → 保存进度 → 生成报告 → 保存最终报告 → 结束
```

### 9.2 API 调用流程

| 步骤 | API | 说明 |
|-----|-----|------|
| 1. 检查进行中面试 | `GET /api/open/interviews?userId=xxx&status=IN_PROGRESS` | 断点恢复用 |
| 2. 创建面试记录 | `POST /api/open/interviews` | 新面试用 |
| 3. 保存进度 | `PATCH /api/open/interviews/{id}` | 每题保存 |
| 4. 完成面试 | `PATCH /api/open/interviews/{id}` | status=COMPLETED |

### 9.3 断点恢复逻辑

```
用户进入面试功能
    ↓
调用 GET /api/open/interviews?userId=xxx&status=IN_PROGRESS
    ↓
├── 返回有数据 → 从断点继续
│   - 获取 interview_id, currentIndex, outline, answers
│   - 从第 (currentIndex + 1) 题继续
│
└── 返回空 → 创建新面试
    - POST /api/open/interviews (status=IN_PROGRESS, currentIndex=0)
```

---

## 十、相关文档

| 文档 | 用途 |
|-----|------|
| **技术框架（本文档）** | 仅包含已验证信息 |
| **沟通文档** | 包含官方未验证的解答，用于问题反馈 |
| **测试报告** | `Coze-API测试报告-2026-02-28.md` |
| **问题咨询** | `Coze-API端点问题咨询.md` |

---

*文档版本: 3.1 | 更新时间: 2026-02-28*
*架构类型: 纯 B 端 API 架构（仅包含已验证信息）*
*核心原则: 未经验证的内容不纳入技术文档*
