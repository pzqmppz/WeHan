generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Application {
  id              String            @id
  userId          String?
  externalUserId  String?           // C端用户ID（豆包user_id）
  jobId           String
  resumeId        String?
  interviewId     String?           @unique
  matchScore      Float?
  status          ApplicationStatus @default(PENDING)
  notes           String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  viewedAt        DateTime?
  Job             Job               @relation(fields: [jobId], references: [id], onDelete: Cascade)
  User            User?             @relation(fields: [userId], references: [id], onDelete: Cascade)
  Interview       Interview?

  @@unique([userId, jobId])
  @@index([createdAt])
  @@index([status])
  @@index([externalUserId])
}

// C端会话管理（不关联User表）
model Conversation {
  id                  String   @id @default(cuid())
  externalUserId      String   // 豆包用户ID
  cozeConversationId  String   @unique // Coze会话ID
  title               String?
  status              String   @default("active") // active/finished/interrupted
  type                String?  // interview/counseling/general
  sessionData         Json?    // 完整会话数据（messages, workflowStatus等）
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([externalUserId])
  @@index([cozeConversationId])
  @@index([status])
}

model EmotionRecord {
  id        String   @id
  userId    String
  emotion   String
  score     Int
  content   String?
  tags      String[]
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([userId])
}

model Enterprise {
  id              String   @id
  name            String
  logo            String?
  industry        String
  scale           String
  description     String?
  address         String?
  contactName     String?
  contactPhone    String?
  contactEmail    String?
  businessLicense String?
  verified        Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime
  Job             Job[]
  User            User[]

  @@index([industry])
  @@index([verified])
}

model Interview {
  id              String          @id
  userId          String?
  externalUserId  String?         // C端用户ID（豆包user_id）
  jobId           String?
  applicationId   String?         @unique

  // ===== 面试内容 =====
  outline         Json?           // 题目列表
  currentIndex    Int?            @default(0)   // 当前面试进度（第几题，用于断点恢复）
  answers         Json?                       // 回答记录数组（代码层初始化为空数组）

  // ===== 原始记录 =====
  conversation    Json?           // 原始对话记录
  duration        Int?
  audioUrl        String?

  // ===== 评估结果 =====
  status          InterviewStatus @default(PREPARING)
  totalScore      Float?
  dimensions      Json?           // 维度评分
  highlights      Json?           // 亮点
  improvements    Json?           // 改进建议
  suggestions     String?         // 综合建议

  // ===== 时间戳 =====
  createdAt       DateTime        @default(now())
  updatedAt       DateTime
  completedAt     DateTime?

  // ===== 关联 =====
  Application     Application?    @relation(fields: [applicationId], references: [id])
  User            User?           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([userId])
  @@index([externalUserId])
}

model Job {
  id                 String          @id
  title              String
  enterpriseId       String
  industry           String?
  category           String?
  salaryMin          Int?
  salaryMax          Int?
  location           String?
  address            String?
  description        String
  requirements       String?
  benefits           String?
  skills             String[]
  educationLevel     String?
  experienceYears    Int?
  freshGraduate      Boolean         @default(true)
  headcount          Int             @default(1)
  status             JobStatus       @default(DRAFT)
  interviewQuestions String?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime
  publishedAt        DateTime?
  Application        Application[]
  Enterprise         Enterprise      @relation(fields: [enterpriseId], references: [id], onDelete: Cascade)
  JobPushRecord      JobPushRecord[]

  @@index([enterpriseId])
  @@index([industry])
  @@index([location])
  @@index([status])
}

model JobPushRecord {
  id           String   @id
  jobId        String
  schoolId     String
  targetMajors String[]
  pushCount    Int      @default(0)
  createdAt    DateTime @default(now())
  Job          Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  School       School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([schoolId])
}

model Policy {
  id            String     @id
  title         String
  type          PolicyType
  content       String
  summary       String?
  conditions    String?
  benefits      String?
  effectiveDate DateTime?
  expiryDate    DateTime?
  isActive      Boolean    @default(true)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime

  @@index([isActive])
  @@index([type])
}

model PortalConfig {
  id          String   @id
  key         String   @unique
  value       Json
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime
}

model Resume {
  id             String   @id
  userId         String?  @unique
  externalUserId String?  // C端用户ID（豆包user_id）
  resumeText     String?  // 原始简历文本（PDF解析后）
  originalUrl    String?
  name           String?
  phone          String?
  email          String?
  education      Json?
  experiences    Json?
  projects       Json?
  skills         String[]
  certifications Json?
  awards         Json?
  profile        Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime
  User           User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([externalUserId])
}

model School {
  id            String          @id
  name          String
  logo          String?
  type          String
  level         String
  address       String?
  contactName   String?
  contactPhone  String?
  verified      Boolean         @default(false)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  JobPushRecord JobPushRecord[]
  User          User[]

  @@index([verified])
}

model Statistics {
  id        String   @id
  date      DateTime @db.Date
  type      String
  key       String
  value     Int
  createdAt DateTime @default(now())

  @@unique([date, type, key])
  @@index([date])
  @@index([type])
}

model User {
  id              String          @id
  email           String          @unique
  phone           String?         @unique
  password        String
  name            String
  avatar          String?
  role            UserRole
  status          UserStatus      @default(PENDING)
  schoolId        String?
  major           String?
  graduationYear  Int?
  enterpriseId    String?
  schoolManagedId String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime
  lastLoginAt     DateTime?
  Application     Application[]
  EmotionRecord   EmotionRecord[]
  Interview       Interview[]
  Resume          Resume[]
  Enterprise      Enterprise?     @relation(fields: [enterpriseId], references: [id])
  School          School?         @relation(fields: [schoolManagedId], references: [id])

  @@index([role])
  @@index([status])
}

enum ApplicationStatus {
  PENDING
  VIEWED
  INTERVIEWING
  OFFERED
  REJECTED
  WITHDRAWN
}

enum InterviewStatus {
  PREPARING
  IN_PROGRESS
  COMPLETED
  EXPIRED
}

enum JobStatus {
  DRAFT
  PUBLISHED
  CLOSED
  ARCHIVED
}

enum PolicyType {
  SUBSIDY
  HOUSING
  TALENT
  ENTREPRENEUR
  OTHER
}

enum UserRole {
  STUDENT
  ENTERPRISE
  SCHOOL
  GOVERNMENT
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING
  REJECTED
}
